# Change Log: 2026-02-10 16:00

## Summary
Refactored stat cap penalty system with hybrid formula (% OR gap) and day-based cap adjustments.

## Changes Made

### 1. config.json
- Updated `stat_cap_penalty` section:
  - `start_penalty_percent`: 50 → 80
  - Added `start_penalty_gap`: 200
  - Added `day_cap_adjustments`:
    - `day_75`: 30
    - `day_74`: 45
    - `day_73_and_below`: 60

### 2. utils/constants.py
- Updated `DEFAULT_STAT_CAPS`:
  - spd: 1130 → 1200
  - sta: 1100 (unchanged)
  - pwr: 1080 → 1200
  - guts: 1100 → 1200
  - wit: 1130 → 1200

### 3. core/logic.py
- Updated `get_stat_caps()` fallback values to new defaults
- Updated `get_stat_cap_penalty_config()` to include new config fields:
  - `start_penalty_gap`
  - `day_75_adjustment`, `day_74_adjustment`, `day_73_and_below_adjustment`
- Added `get_effective_stat_cap(base_cap, absolute_day, penalty_config)`:
  - Returns base_cap - adjustment based on day
- Added `get_all_effective_stat_caps(absolute_day, penalty_config)`:
  - Returns dict of all effective caps for given day
- Rewrote `_calculate_single_stat_penalty()`:
  - Removed taper/time_factor logic
  - Uses hybrid trigger: MIN(cap × 80%, cap - 200)
  - Formula: fill_factor² × max_penalty_percent
- Updated `filter_by_stat_caps()`:
  - Uses effective caps instead of base caps
  - Logs effective cap info for days 73, 74, 75
- Updated `apply_single_training_penalty()`:
  - Uses effective caps
  - Shows both effective and base cap in penalty info

### 4. bot_settings.json
- Updated all preset stat_caps to new defaults:
  - spd: 1200, pwr: 1200, guts: 1200, wit: 1200
  - (sta values preserved: 1100, 500, or 400 depending on preset)

## Formula Changes

### Old Formula (ratio-based with taper):
```
fill_ratio = current_stat / stat_cap
time_factor = min(remaining_days, 5) / 5
penalty = fill_factor² × time_factor × max_penalty
```

### New Formula (hybrid, no taper):
```
effective_cap = base_cap - day_adjustment
trigger_by_percent = effective_cap × 0.80
trigger_by_gap = effective_cap - 200
actual_trigger = MIN(trigger_by_percent, trigger_by_gap)
fill_factor = (current - actual_trigger) / (effective_cap - actual_trigger)
penalty = fill_factor² × max_penalty
```

### Day-based Effective Caps:
| Day | Adjustment | Example (base 1200) |
|-----|------------|---------------------|
| ≤73 | -60 | 1140 |
| 74 | -45 | 1155 |
| 75 | -30 | 1170 |

## Testing Notes
- Run application and verify penalty calculations in activity log
- Check days 73, 74, 75 show correct effective caps
- Verify hybrid trigger works (lower cap stats trigger by gap, higher by %)

## Files Modified
- `config.json`
- `utils/constants.py`
- `core/logic.py`
- `bot_settings.json`
- `.claude/PROJECT_SUMMARY.md`
