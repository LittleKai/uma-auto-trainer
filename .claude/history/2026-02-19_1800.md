# Change Log: 2026-02-19 18:00

## Session Info
- **Type:** Feature
- **Request:** "Implement Race Scheduler feature"
- **Files Modified:** 4
- **Files Created:** 1
- **Files Deleted:** 0

---

## Changes Made

### 1. Race Data Enhancement
**What changed:**
- Added `fan_gain` field to all 387 races in `assets/race_list.json`
- Fan gain values based on grade: G1: 3500-10500, G2: 2000-3500, G3: 1800, OP: 1000, Pre-OP: 750, Unknown: 500
- Notable G1 races have specific higher values (e.g., Japan Cup: 10500, Derby: 9500)

**Files affected:**
- `assets/race_list.json`

### 2. Race Manager - Preferred Races
**What changed:**
- Added `preferred_races` list to `RaceManager.__init__`
- Added `set_preferred_races(race_names)` to set preferred race list from UI
- Added `compute_absolute_day(race)` to calculate absolute day from race year/date
- Added `is_preferred_race_day(current_date)` - checks if today has a preferred race that also passes strategy filters

**Files affected:**
- `core/race_manager.py`

### 3. Bot Logic Integration
**What changed:**
- In `career_lobby()`: loads preferred races from GUI event choice settings at bot start
- In `DecisionEngine.make_decision()`: checks `is_preferred_race_day()` after mood handling but before energy/racing/training flow
- If preferred race day detected and race passes filters, forces race flow
- Falls back to normal flow if race not found in game

**Files affected:**
- `core/execute.py`

### 4. Race Schedule UI
**What changed:**
- Added `DEFAULT_RACE_SCHEDULE` constant (Hanshin Juvenile Fillies day 23, Hopeful Stakes day 24)
- Added `race_schedule` to each preset set
- Created Race Schedule section (row 4) with Treeview (Day, Name, Grade columns)
- Add Race button opens `RaceScheduleDialog` to select from all races
- Delete button/Delete key removes selected race
- Reset button restores defaults
- Race schedule resets to defaults when Uma Musume changes (not during preset switch)
- Per-preset save/load of race schedule in `get_settings()`/`load_settings()`
- Preset switching swaps race schedule data and refreshes tree

**Files affected:**
- `gui/tabs/event_choice_tab.py`

### 5. Race Schedule Dialog
**What changed:**
- Created new dialog for selecting races from `race_list.json`
- Modal Toplevel with search entry and Treeview
- Columns: Day, Name, Year, Date, Grade, Track, Distance, Fan Gain
- Double-click or Add button returns selected race with absolute_day
- Sorted by absolute_day

**Files affected:**
- `gui/dialogs/race_schedule_dialog.py` (new)

---

## Testing Performed
- [x] All modified files compile without syntax errors
- [x] `race_list.json` validated - all 387 races have `fan_gain`
- [x] Integration test: `RaceManager` preferred race detection works correctly
- [x] Preferred races on correct days return True
- [x] Non-preferred days return False
- [x] Preferred races violating filters (e.g., turf blocked) correctly skipped

---

## Documentation Updates
- [x] Updated PROJECT_SUMMARY.md (sections 2, 4, 7)
- [x] Added race_schedule_dialog.py to file structure
- [x] Updated Race Scheduler feature status from Planning to Done
- [x] Added session entry to Recent Changes

---

## Known Issues / TODOs Added
- None

---

## Notes
- The preferred race check runs early in the decision flow (after mood, before energy/strategy checks)
- This means preferred races will be attempted even at medium energy levels
- However, if the race isn't found in the game client, it gracefully falls back to normal flow
- The `is_preferred_race_day()` method respects all Strategy Tab filters, so users can't accidentally race in filtered-out categories

---

**Status:** Completed
